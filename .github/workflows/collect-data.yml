name: æ”¶é›†æµ‹è¯•æ•°æ®

# è§¦å‘æ¡ä»¶ï¼šé€šè¿‡APIè°ƒç”¨ï¼ˆrepository_dispatchï¼‰
on:
  repository_dispatch:
    types: [submit-test-data]

jobs:
  save-data:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®PythonçŽ¯å¢ƒï¼ˆç”¨äºŽæ•°æ®å¤„ç†ï¼‰
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pandas openpyxl pytz

      # 4. åˆ›å»ºæ•°æ®ç›®å½•
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: |
          mkdir -p data/raw
          mkdir -p data/reports

      # 5. ä¿å­˜åŽŸå§‹æ•°æ®
      - name: ä¿å­˜æµ‹è¯•æ•°æ®
        run: |
          # ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FILENAME="data/raw/test_${TIMESTAMP}_${{ github.event.client_payload.anonymousId }}.json"

          # ä¿å­˜å®Œæ•´æ•°æ®
          cat > "$FILENAME" << 'EOF'
          ${{ toJSON(github.event.client_payload) }}
          EOF

          echo "æ•°æ®å·²ä¿å­˜åˆ°: $FILENAME"

      # 6. æ›´æ–°æ±‡æ€»æ•°æ®
      - name: æ›´æ–°æ±‡æ€»ç»Ÿè®¡
        run: |
          python scripts/update_summary.py

      # 7. æäº¤åˆ°ä»“åº“
      - name: æäº¤æ•°æ®
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/
          git commit -m "ðŸ“Š æ–°å¢žæµ‹è¯•æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— æ–°æ•°æ®éœ€è¦æäº¤"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
