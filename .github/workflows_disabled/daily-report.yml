name: æ¯æ—¥æ•°æ®æŠ¥è¡¨

# æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ = UTC+8ï¼Œå³UTC 18:00ï¼‰
on:
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = åŒ—äº¬æ—¶é—´ 02:00
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pandas openpyxl matplotlib seaborn pytz

      # 4. ç”Ÿæˆæ¯æ—¥æŠ¥è¡¨
      - name: ç”Ÿæˆç»Ÿè®¡æŠ¥è¡¨
        run: |
          python scripts/generate_daily_report.py

      # 5. ç”ŸæˆExcelæ±‡æ€»
      - name: ç”ŸæˆExcelæŠ¥è¡¨
        run: |
          python scripts/export_to_excel.py

      # 6. æäº¤æŠ¥è¡¨
      - name: æäº¤æŠ¥è¡¨åˆ°ä»“åº“
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/reports/
          git commit -m "ğŸ“ˆ æ¯æ—¥æ•°æ®æŠ¥è¡¨ $(date +'%Y-%m-%d')" || echo "æ— æ–°æŠ¥è¡¨éœ€è¦æäº¤"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. æ¸…ç†æ—§æ•°æ®ï¼ˆå¯é€‰ï¼Œä¿ç•™æœ€è¿‘90å¤©ï¼‰
      - name: æ¸…ç†æ—§æ•°æ®
        run: |
          python scripts/cleanup_old_data.py --days 90
          git add data/
          git commit -m "ğŸ§¹ æ¸…ç†90å¤©å‰çš„æ—§æ•°æ®" || echo "æ— æ—§æ•°æ®éœ€è¦æ¸…ç†"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
